##############################################################################
#
#  QuantLib-Risks Benchmarks
#
#  Compares different AD configurations for Swaption pricing:
#  - QL + XAD:       QuantLib-Risks-Cpp with XAD tape (baseline)
#  - QL + XAD-Forge: QuantLib-Risks-Cpp with Forge JIT backends
#
#  Jobs:
#  - Linux/Windows, QL + XAD:       True baseline (original repo, XAD tape)
#  - Linux/Windows, QL + XAD-Forge: Forge JIT (runs XAD tape + JIT + JIT-AVX)
#  - Decomposition:                 Detailed timing breakdown
#  - Compare:                       Statistical comparison XAD vs XAD-Forge
#
#  Dependencies:
#  - QuantLib (lballabio/QuantLib)
#  - XAD (auto-differentiation/xad)
#  - QuantLib-Risks-Cpp (auto-differentiation/QuantLib-Risks-Cpp) [baseline]
#  - xad-forge (da-roth/xad-forge) [Forge jobs]
#  - Forge C API (da-roth/forge) [Forge jobs]
#
#  Copyright (C) 2025 Xcelerit Computing Limited
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: QL Benchmarks

on:
  push:
    paths:
      - 'test-suite/swaption_benchmark*.cpp'
      - 'test-suite/benchmark_main.cpp'
      - 'test-suite/benchmark_utils.hpp'
      - '.github/workflows/ql-benchmarks.yaml'
  pull_request:
    paths:
      - 'test-suite/swaption_benchmark*.cpp'
      - 'test-suite/benchmark_main.cpp'
      - 'test-suite/benchmark_utils.hpp'
      - '.github/workflows/ql-benchmarks.yaml'
  workflow_dispatch:
    inputs:
      ql_repo:
        description: 'QuantLib repository'
        required: false
        default: 'lballabio/QuantLib'
      ql_branch:
        description: 'QuantLib branch'
        required: false
        default: 'master'
      xad_repo:
        description: 'XAD repository'
        required: false
        default: 'auto-differentiation/xad'
      xad_branch:
        description: 'XAD branch'
        required: false
        default: 'main'
      qlrisks_repo:
        description: 'QuantLib-Risks-Cpp repository (for baseline)'
        required: false
        default: 'auto-differentiation/QuantLib-Risks-Cpp'
      qlrisks_branch:
        description: 'QuantLib-Risks-Cpp branch (for baseline)'
        required: false
        default: 'main'
      forge_repo:
        description: 'Forge repository'
        required: false
        default: 'da-roth/forge'
      forge_branch:
        description: 'Forge branch'
        required: false
        default: 'main'
      xad_forge_repo:
        description: 'xad-forge repository'
        required: false
        default: 'da-roth/xad-forge'
      xad_forge_branch:
        description: 'xad-forge branch'
        required: false
        default: 'main'

env:
  QL_REPO: ${{ github.event.inputs.ql_repo || 'lballabio/QuantLib' }}
  QL_BRANCH: ${{ github.event.inputs.ql_branch || 'master' }}
  XAD_REPO: ${{ github.event.inputs.xad_repo || 'auto-differentiation/xad' }}
  XAD_BRANCH: ${{ github.event.inputs.xad_branch || 'main' }}
  QLRISKS_REPO: ${{ github.event.inputs.qlrisks_repo || 'auto-differentiation/QuantLib-Risks-Cpp' }}
  QLRISKS_BRANCH: ${{ github.event.inputs.qlrisks_branch || 'main' }}
  FORGE_REPO: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  FORGE_BRANCH: ${{ github.event.inputs.forge_branch || 'main' }}
  XAD_FORGE_REPO: ${{ github.event.inputs.xad_forge_repo || 'da-roth/xad-forge' }}
  XAD_FORGE_BRANCH: ${{ github.event.inputs.xad_forge_branch || 'main' }}

jobs:
  ##############################################################################
  # Linux, QL + XAD (True Baseline)
  # Uses original QuantLib-Risks-Cpp with XAD tape - no Forge code
  ##############################################################################
  linux-xad:
    name: Linux, QL + XAD
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-ql-xad
          max-size: 650M

      - name: Configure QuantLib
        run: |
          cd QuantLib
          cmake -B build -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=OFF \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad;$(pwd)/../QuantLib-Risks-Cpp" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON

      - name: Build
        run: |
          cd QuantLib/build
          cmake --build . --target QuantLib-Risks_benchmark_standalone

      - name: Run Benchmark
        run: |
          cd QuantLib/build
          ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone

  ##############################################################################
  # Linux, QL + XAD-Forge
  # Uses QuantLib-Risks-Cpp with Forge JIT backends
  # Runs all methods: XAD tape + JIT-Forge + JIT-ForgeAVX2
  ##############################################################################
  linux-xad-forge:
    name: Linux, QL + XAD-Forge
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-ql-xad-forge
          max-size: 650M

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Configure QuantLib
        run: |
          cd QuantLib
          cmake -B build -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad;$(pwd)/../xad-forge;$(pwd)/../QuantLib-Risks-Cpp" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_ENABLE_FORGE=ON \
            -DQLRISKS_USE_FORGE_CAPI=ON \
            -DXAD_FORGE_USE_CAPI=ON \
            -DQLRISKS_BUILD_TEST_SUITE=OFF \
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Run Benchmark
        run: |
          cd QuantLib/build
          export LD_LIBRARY_PATH=$(pwd)/../../install/lib:$LD_LIBRARY_PATH
          ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone

  ##############################################################################
  # Windows, QL + XAD (True Baseline)
  ##############################################################################
  windows-xad:
    name: Windows, QL + XAD
    runs-on: windows-2022

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: choco install -y ninja

      - name: Setup Boost
        run: |
          $Url = "https://downloads.sourceforge.net/project/boost/boost-binaries/1.86.0/boost_1_86_0-msvc-14.3-64.exe"
          (New-Object System.Net.WebClient).DownloadFile($Url, "$RUNNER_TEMP\boost.exe")
          Start-Process -Wait -FilePath "$RUNNER_TEMP\boost.exe" "/SILENT","/SP-","/SUPPRESSMSGBOXES","/DIR=C:\local\boost"
          echo "BOOST_ROOT=C:\local\boost" >> $env:GITHUB_ENV

      - name: Configure QuantLib
        shell: cmd
        run: |
          cd QuantLib
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_WARNINGS_PARANOID=OFF ^
            -DXAD_ENABLE_JIT=OFF ^
            -DXAD_STATIC_MSVC_RUNTIME=ON ^
            -DQL_EXTERNAL_SUBDIRECTORIES="%cd%\..\xad;%cd%\..\QuantLib-Risks-Cpp" ^
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks ^
            -DQL_NULL_AS_FUNCTIONS=ON ^
            -DQL_BUILD_TEST_SUITE=OFF ^
            -DQL_BUILD_EXAMPLES=OFF ^
            -DQL_BUILD_BENCHMARK=OFF ^
            -DQLRISKS_DISABLE_AAD=OFF ^
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON

      - name: Build
        shell: cmd
        run: |
          cd QuantLib\build
          call "%VSVARSALL%" amd64
          cmake --build . --target QuantLib-Risks_benchmark_standalone --config Release

      - name: Run Benchmark
        shell: cmd
        run: |
          cd QuantLib\build
          QuantLib-Risks-Cpp\test-suite\quantlib-risks-benchmark-standalone.exe

  ##############################################################################
  # Windows, QL + XAD-Forge
  ##############################################################################
  windows-xad-forge:
    name: Windows, QL + XAD-Forge
    runs-on: windows-2022

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: choco install -y ninja

      - name: Setup Boost
        run: |
          $Url = "https://downloads.sourceforge.net/project/boost/boost-binaries/1.86.0/boost_1_86_0-msvc-14.3-64.exe"
          (New-Object System.Net.WebClient).DownloadFile($Url, "$RUNNER_TEMP\boost.exe")
          Start-Process -Wait -FilePath "$RUNNER_TEMP\boost.exe" "/SILENT","/SP-","/SUPPRESSMSGBOXES","/DIR=C:\local\boost"
          echo "BOOST_ROOT=C:\local\boost" >> $env:GITHUB_ENV

      - name: Build Forge C API
        shell: cmd
        run: |
          cd forge
          call "%VSVARSALL%" amd64
          cmake -B build -S api/c -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DFORGE_CAPI_BUILD_TESTS=OFF ^
            -DFORGE_CAPI_USE_STATIC_RUNTIME=ON ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build
          cmake --install build

      - name: Configure QuantLib
        shell: cmd
        run: |
          cd QuantLib
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=Release ^
            -DCMAKE_CXX_STANDARD=17 ^
            -DXAD_WARNINGS_PARANOID=OFF ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_STATIC_MSVC_RUNTIME=ON ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DQL_EXTERNAL_SUBDIRECTORIES="%cd%\..\xad;%cd%\..\xad-forge;%cd%\..\QuantLib-Risks-Cpp" ^
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks ^
            -DQL_NULL_AS_FUNCTIONS=ON ^
            -DQL_BUILD_TEST_SUITE=OFF ^
            -DQL_BUILD_EXAMPLES=OFF ^
            -DQL_BUILD_BENCHMARK=OFF ^
            -DQLRISKS_DISABLE_AAD=OFF ^
            -DQLRISKS_ENABLE_FORGE=ON ^
            -DQLRISKS_USE_FORGE_CAPI=ON ^
            -DXAD_FORGE_USE_CAPI=ON ^
            -DQLRISKS_BUILD_TEST_SUITE=OFF ^
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON ^
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build
        shell: cmd
        run: |
          cd QuantLib\build
          call "%VSVARSALL%" amd64
          cmake --build . --config Release

      - name: Run Benchmark
        shell: cmd
        run: |
          cd QuantLib\build
          set PATH=%cd%\..\..\install\bin;%PATH%
          QuantLib-Risks-Cpp\test-suite\quantlib-risks-benchmark-standalone.exe

  ##############################################################################
  # Performance Decomposition - Detailed timing breakdown (XAD-Forge)
  ##############################################################################
  decomposition:
    name: Decomposition
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-decomposition
          max-size: 650M

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Configure QuantLib
        run: |
          cd QuantLib
          cmake -B build -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad;$(pwd)/../xad-forge;$(pwd)/../QuantLib-Risks-Cpp" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_ENABLE_FORGE=ON \
            -DQLRISKS_USE_FORGE_CAPI=ON \
            -DXAD_FORGE_USE_CAPI=ON \
            -DQLRISKS_BUILD_TEST_SUITE=OFF \
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Run Performance Decomposition
        run: |
          cd QuantLib/build
          export LD_LIBRARY_PATH=$(pwd)/../../install/lib:$LD_LIBRARY_PATH
          ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone --decomposition

  ##############################################################################
  # Compare XAD vs XAD-Forge - Statistical comparison
  ##############################################################################
  compare:
    name: Compare XAD vs XAD-Forge
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/lballabio/quantlib-devenv:rolling

    steps:
      - name: Hardware Info
        run: |
          echo "===== CPU ====="
          lscpu | grep -E "^(Model name|CPU\(s\)|Thread|Core|Socket|CPU max MHz)"
          echo "===== Memory ====="
          free -h

      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.QL_REPO }}
          ref: ${{ env.QL_BRANCH }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_REPO }}
          ref: ${{ env.XAD_BRANCH }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.FORGE_REPO }}
          ref: ${{ env.FORGE_BRANCH }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.XAD_FORGE_REPO }}
          ref: ${{ env.XAD_FORGE_BRANCH }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp

      - name: Setup
        run: |
          apt-get update
          apt-get install -y ninja-build cmake bc

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-compare
          max-size: 650M

      # --- Build QL + XAD (baseline) ---
      - name: Configure QuantLib (QL + XAD)
        run: |
          cd QuantLib
          cmake -B build-xad -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=OFF \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad;$(pwd)/../QuantLib-Risks-Cpp" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON

      - name: Build (QL + XAD)
        run: |
          cd QuantLib/build-xad
          cmake --build . --target QuantLib-Risks_benchmark_standalone

      # --- Build QL + XAD-Forge ---
      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFORGE_CAPI_BUILD_TESTS=OFF \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Configure QuantLib (QL + XAD-Forge)
        run: |
          cd QuantLib
          cmake -B build-forge -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad;$(pwd)/../xad-forge;$(pwd)/../QuantLib-Risks-Cpp" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_ENABLE_FORGE=ON \
            -DQLRISKS_USE_FORGE_CAPI=ON \
            -DXAD_FORGE_USE_CAPI=ON \
            -DQLRISKS_BUILD_TEST_SUITE=OFF \
            -DQLRISKS_BUILD_BENCHMARK_STANDALONE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build (QL + XAD-Forge)
        run: |
          cd QuantLib/build-forge
          cmake --build .

      # --- Run benchmarks multiple times ---
      - name: Run Benchmark (QL + XAD)
        run: |
          set -e
          cd QuantLib/build-xad
          # warmup run
          ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone --quick
          rm -f benchmark_xad.log || true
          for i in $(seq 1 5) ; do \
            ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone | tee -a benchmark_xad.log ; \
          done

      - name: Run Benchmark (QL + XAD-Forge)
        run: |
          set -e
          cd QuantLib/build-forge
          export LD_LIBRARY_PATH=$(pwd)/../../install/lib:$LD_LIBRARY_PATH
          # warmup run
          ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone --quick
          rm -f benchmark_forge.log || true
          for i in $(seq 1 5) ; do \
            ./QuantLib-Risks-Cpp/test-suite/quantlib-risks-benchmark-standalone | tee -a benchmark_forge.log ; \
          done

      - name: Compare Results
        id: compare
        run: |
          set -e

          echo "## Benchmark Comparison: QL + XAD vs QL + XAD-Forge" > benchmark_results.md
          echo "" >> benchmark_results.md
          echo "Comparing original QuantLib-Risks-Cpp (XAD tape) vs Forge repo (JIT + JIT-AVX)." >> benchmark_results.md
          echo "" >> benchmark_results.md
          echo "- Commit: \`${{ github.sha }}\`" >> benchmark_results.md
          echo "- Runs: 5 (after warmup)" >> benchmark_results.md
          echo "" >> benchmark_results.md

          echo "### QL + XAD (Baseline)" >> benchmark_results.md
          echo "\`\`\`" >> benchmark_results.md
          tail -80 QuantLib/build-xad/benchmark_xad.log >> benchmark_results.md || echo "No log available" >> benchmark_results.md
          echo "\`\`\`" >> benchmark_results.md
          echo "" >> benchmark_results.md

          echo "### QL + XAD-Forge" >> benchmark_results.md
          echo "\`\`\`" >> benchmark_results.md
          tail -80 QuantLib/build-forge/benchmark_forge.log >> benchmark_results.md || echo "No log available" >> benchmark_results.md
          echo "\`\`\`" >> benchmark_results.md

          cat benchmark_results.md

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-compare
          path: benchmark_results.md

