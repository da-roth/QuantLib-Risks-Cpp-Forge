##############################################################################
#
#  QuantLib-Risks-Cpp-Forge CI Workflow
#
#  This workflow mirrors the original QuantLib-Risks-Cpp CI and additionally
#  tests with Forge JIT acceleration on Linux and Windows.
#
#  Jobs:
#  - xad-linux: Original XAD tests (C++17, C++20, AAD ON/OFF)
#  - xad-win: Original XAD tests (C++17, C++20, AAD ON/OFF)
#  - xad-macos: Original XAD tests (C++17, C++20, AAD ON/OFF)
#  - xad-linux-std-classes: Original XAD with QL_USE_STD_CLASSES
#  - forge-linux: XAD + Forge JIT tests (C++17, Release/Debug)
#  - forge-windows: XAD + Forge JIT tests (C++17, Release/Debug)
#
#  Copyright (C) 2025 The QuantLib-Risks-Cpp-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      ql_repo:
        description: QuantLib repository in <owner>/<repo> format
        required: true
        default: lballabio/QuantLib
      ql_branch:
        description: Branch or tag for QuantLib repository
        required: true
        default: master
      xad_repo:
        description: XAD repository in <owner>/<repo> format
        required: true
        default: auto-differentiation/xad
      xad_branch:
        description: Branch or tag for XAD repository
        required: true
        default: main
      forge_repo:
        description: Forge repository in <owner>/<repo> format
        required: true
        default: da-roth/forge
      forge_branch:
        description: Branch or tag for Forge repository
        required: true
        default: main
      xad_forge_repo:
        description: xad-forge repository in <owner>/<repo> format
        required: true
        default: da-roth/xad-forge
      xad_forge_branch:
        description: Branch or tag for xad-forge repository
        required: true
        default: main

env:
  ql_repo: ${{ github.event.inputs.ql_repo || 'lballabio/QuantLib' }}
  ql_branch: ${{ github.event.inputs.ql_branch || 'master' }}
  xad_repo: ${{ github.event.inputs.xad_repo || 'auto-differentiation/xad' }}
  xad_branch: ${{ github.event.inputs.xad_branch || 'main' }}
  forge_repo: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  forge_branch: ${{ github.event.inputs.forge_branch || 'main' }}
  xad_forge_repo: ${{ github.event.inputs.xad_forge_repo || 'da-roth/xad-forge' }}
  xad_forge_branch: ${{ github.event.inputs.xad_forge_branch || 'main' }}

jobs:
  ##############################################################################
  # Linux - Original XAD (mirrors QuantLib-Risks-Cpp)
  #
  # Note on disable_aad naming: This uses the original QuantLib-Risks-Cpp
  # convention where QLRISKS_DISABLE_AAD=OFF means AAD is ENABLED (not disabled).
  # The confusing double-negative is preserved for compatibility.
  ##############################################################################
  xad-linux:
    strategy:
      fail-fast: false
      matrix:
        disable_aad: ["ON", "OFF"]
        cxx: ["17", "20"]
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    name: Linux XAD C++${{ matrix.cxx }} AAD=${{ matrix.disable_aad == 'OFF' && 'ON' || 'OFF' }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-xad-${{ matrix.cxx }}-${{ matrix.disable_aad }}
          max-size: 650M

      - name: Setup
        run: |
          apt-get update && apt install -y ccache ninja-build

      - name: Configure
        run: |
          rm -rf ${{ github.workspace }}/install
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} \
            -DQLRISKS_DISABLE_AAD=${{ matrix.disable_aad }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../../xad;$(pwd)/../../QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../../install \
            ..

      - name: Compile
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Test QuantLib
        run: |
          cd QuantLib/build
          ./test-suite/quantlib-test-suite --log_level=message

      - name: Test QuantLib-Risks
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          cd QuantLib/build
          ./QuantLib-Risks-Cpp-Forge/test-suite/quantlib-risks-test-suite --log_level=message

      - name: Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          cd QuantLib/build
          cmake --install .

      - name: Test Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          mkdir installtest
          cp QuantLib-Risks-Cpp-Forge/Examples/AdjointSwap/AdjointSwapXAD.cpp installtest
          cd installtest
          echo "cmake_minimum_required(VERSION 3.15.2)" > CMakeLists.txt
          echo "project(QlTest LANGUAGES CXX)" >> CMakeLists.txt
          echo "find_package(QuantLib-Risks REQUIRED)" >> CMakeLists.txt
          echo "add_executable(AdjointSwapXAD AdjointSwapXAD.cpp)" >> CMakeLists.txt
          echo "target_link_libraries(AdjointSwapXAD PRIVATE QuantLib::QuantLib)" >> CMakeLists.txt
          echo "target_compile_features(AdjointSwapXAD PUBLIC cxx_std_17)" >> CMakeLists.txt
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=$(pwd)/../../install \
            ..
          cmake --build .
          ./AdjointSwapXAD

  ##############################################################################
  # Windows - Original XAD (mirrors QuantLib-Risks-Cpp)
  ##############################################################################
  xad-win:
    strategy:
      fail-fast: false
      matrix:
        disable_aad: ["ON", "OFF"]
        cxx: ["17", "20"]
    runs-on: windows-2022

    name: Windows XAD C++${{ matrix.cxx }} AAD=${{ matrix.disable_aad == 'OFF' && 'ON' || 'OFF' }}

    env:
      vsvarsall: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: sccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: windows-xad-${{ matrix.cxx }}-${{ matrix.disable_aad }}
          variant: sccache
          max-size: 650M

      - name: Setup
        run: |
          choco install -y ninja
          $Url = "https://downloads.sourceforge.net/project/boost/boost-binaries/1.86.0/boost_1_86_0-msvc-14.3-64.exe"
          (New-Object System.Net.WebClient).DownloadFile($Url, "$RUNNER_TEMP\boost.exe")
          Start-Process -Wait -FilePath "$RUNNER_TEMP\boost.exe" "/SILENT","/SP-","/SUPPRESSMSGBOXES","/DIR=C:\local\boost"

      - name: Configure
        env:
          BOOST_ROOT: C:\local\boost
        shell: cmd
        run: |
          cd QuantLib
          mkdir build
          cd build
          call "${{ env.vsvarsall }}" amd64
          cmake .. -G Ninja -DQLRISKS_DISABLE_AAD=${{ matrix.disable_aad }} ^
          -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} ^
          -DCMAKE_CXX_COMPILER_LAUNCHER=sccache ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DQL_EXTERNAL_SUBDIRECTORIES="${{ github.workspace }}/xad;${{ github.workspace }}/QuantLib-Risks-Cpp-Forge" ^
          -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks ^
          -DQL_NULL_AS_FUNCTIONS=ON ^
          -DXAD_STATIC_MSVC_RUNTIME=ON ^
          -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install

      - name: Build
        shell: cmd
        run: |
          cd QuantLib\build
          call "${{ env.vsvarsall }}" amd64
          cmake --build .

      - name: Test QuantLib
        shell: cmd
        run: |
          cd QuantLib\build
          call "${{ env.vsvarsall }}" amd64
          .\test-suite\quantlib-test-suite --log_level=message

      - name: Test QuantLib-Risks
        if: ${{ matrix.disable_aad == 'OFF' }}
        shell: cmd
        run: |
          cd QuantLib\build
          call "${{ env.vsvarsall }}" amd64
          .\QuantLib-Risks-Cpp-Forge\test-suite\quantlib-risks-test-suite --log_level=message

      - name: Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          cd QuantLib/build
          cmake --install .

      - name: Test Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        env:
          BOOST_ROOT: C:\local\boost
        shell: cmd
        run: |
          mkdir installtest
          copy QuantLib-Risks-Cpp-Forge\Examples\AdjointSwap\AdjointSwapXAD.cpp installtest
          cd installtest
          echo cmake_minimum_required(VERSION 3.15.2) > CMakeLists.txt
          echo project(QlTest LANGUAGES CXX) >> CMakeLists.txt
          echo find_package(QuantLib-Risks REQUIRED) >> CMakeLists.txt
          echo add_executable(AdjointSwapXAD AdjointSwapXAD.cpp) >> CMakeLists.txt
          echo target_link_libraries(AdjointSwapXAD PRIVATE QuantLib::QuantLib) >> CMakeLists.txt
          echo set_target_properties(AdjointSwapXAD PROPERTIES MSVC_RUNTIME_LIBRARY MultiThreaded) >> CMakeLists.txt
          echo target_compile_features(AdjointSwapXAD PUBLIC cxx_std_17) >> CMakeLists.txt
          mkdir build
          cd build
          call "${{ env.vsvarsall }}" amd64
          cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install ..
          cmake --build .
          AdjointSwapXAD.exe

  ##############################################################################
  # macOS - Original XAD (mirrors QuantLib-Risks-Cpp)
  # Note: Forge not supported on macOS ARM yet
  ##############################################################################
  xad-macos:
    strategy:
      fail-fast: false
      matrix:
        disable_aad: ["ON", "OFF"]
        cxx: ["17", "20"]
    runs-on: macos-latest

    name: macOS XAD C++${{ matrix.cxx }} AAD=${{ matrix.disable_aad == 'OFF' && 'ON' || 'OFF' }}

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: Setup
        run: |
          brew install boost ninja ccache

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: macos-xad-${{ matrix.cxx }}-${{ matrix.disable_aad }}
          max-size: 650M

      - name: Configure
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} \
            -DQLRISKS_DISABLE_AAD=${{ matrix.disable_aad }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DQL_EXTERNAL_SUBDIRECTORIES="${{ github.workspace }}/xad;${{ github.workspace }}/QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install \
            ..

      - name: Compile
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Test QuantLib
        run: |
          cd QuantLib/build
          ./test-suite/quantlib-test-suite --log_level=message

      - name: Test QuantLib-Risks
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          cd QuantLib/build
          ./QuantLib-Risks-Cpp-Forge/test-suite/quantlib-risks-test-suite --log_level=message

      - name: Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          cd QuantLib/build
          cmake --install .

      - name: Test Install
        if: ${{ matrix.disable_aad == 'OFF' }}
        run: |
          mkdir installtest
          cp QuantLib-Risks-Cpp-Forge/Examples/AdjointSwap/AdjointSwapXAD.cpp installtest
          cd installtest
          echo "cmake_minimum_required(VERSION 3.15.2)" > CMakeLists.txt
          echo "project(QlTest LANGUAGES CXX)" >> CMakeLists.txt
          echo "find_package(QuantLib-Risks REQUIRED)" >> CMakeLists.txt
          echo "add_executable(AdjointSwapXAD AdjointSwapXAD.cpp)" >> CMakeLists.txt
          echo "target_link_libraries(AdjointSwapXAD PRIVATE QuantLib::QuantLib)" >> CMakeLists.txt
          echo "target_compile_features(AdjointSwapXAD PUBLIC cxx_std_17)" >> CMakeLists.txt
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH=${{ github.workspace }}/install \
            ..
          cmake --build .
          ./AdjointSwapXAD

  ##############################################################################
  # Linux - Original XAD with QL_USE_STD_CLASSES (mirrors QuantLib-Risks-Cpp)
  ##############################################################################
  xad-linux-std-classes:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    name: Linux XAD std-classes

    steps:
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: Setup
        run: |
          apt-get update && apt install -y ccache ninja-build

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-xad-std-classes
          max-size: 650M

      - name: Configure
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DQL_USE_STD_CLASSES=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../../xad;$(pwd)/../../QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            ..

      - name: Compile
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Test QuantLib
        run: |
          cd QuantLib/build
          ./test-suite/quantlib-test-suite --log_level=message

      - name: Test QuantLib-Risks
        run: |
          cd QuantLib/build
          ./QuantLib-Risks-Cpp-Forge/test-suite/quantlib-risks-test-suite --log_level=message

  ##############################################################################
  # Linux - XAD + Forge JIT
  #
  # Forge accelerates AAD tape computations via JIT compilation, so these jobs
  # only make sense with AAD enabled (QLRISKS_DISABLE_AAD=OFF).
  # Tests C++17 and C++20 to match original XAD job coverage.
  ##############################################################################
  forge-linux:
    strategy:
      fail-fast: false
      matrix:
        build_type: ["Release", "Debug"]
        cxx: ["17", "20"]
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    name: Linux Forge C++${{ matrix.cxx }} ${{ matrix.build_type }}

    steps:
      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.forge_repo }}
          ref: ${{ env.forge_branch }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_forge_repo }}
          ref: ${{ env.xad_forge_branch }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp-Forge
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-forge-${{ matrix.build_type }}
          max-size: 650M

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      - name: Build Forge C API
        run: |
          cd forge
          cmake -B build -S api/c \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build --config ${{ matrix.build_type }}
          cmake --install build --config ${{ matrix.build_type }}

      - name: Configure QuantLib with XAD + Forge
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DXAD_ENABLE_JIT=ON \
            -DCMAKE_PREFIX_PATH=$(pwd)/../../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../../xad;$(pwd)/../../xad-forge;$(pwd)/../../QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_ENABLE_FORGE=ON \
            -DQLRISKS_USE_FORGE_CAPI=ON \
            -DXAD_FORGE_USE_CAPI=ON \
            -DQLRISKS_BUILD_TEST_SUITE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON \
            ..

      - name: Build
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Test QuantLib-Risks
        run: |
          cd QuantLib/build
          ./QuantLib-Risks-Cpp-Forge/test-suite/quantlib-risks-test-suite --log_level=message

  ##############################################################################
  # Windows - XAD + Forge JIT
  #
  # Forge accelerates AAD tape computations via JIT compilation, so these jobs
  # only make sense with AAD enabled (QLRISKS_DISABLE_AAD=OFF).
  # Tests C++17 and C++20 to match original XAD job coverage.
  ##############################################################################
  forge-windows:
    strategy:
      fail-fast: false
      matrix:
        build_type: ["Release", "Debug"]
        cxx: ["17", "20"]
    runs-on: windows-2022

    name: Windows Forge C++${{ matrix.cxx }} ${{ matrix.build_type }}

    env:
      VSVARSALL: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat

    steps:
      - name: Checkout QuantLib
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ql_repo }}
          ref: ${{ env.ql_branch }}
          path: QuantLib

      - name: Checkout XAD
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.forge_repo }}
          ref: ${{ env.forge_branch }}
          path: forge

      - name: Checkout xad-forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_forge_repo }}
          ref: ${{ env.xad_forge_branch }}
          path: xad-forge

      - name: Checkout QuantLib-Risks-Cpp-Forge
        uses: actions/checkout@v4
        with:
          path: QuantLib-Risks-Cpp-Forge

      - name: Setup
        run: choco install -y ninja

      - name: Setup Boost
        run: |
          $Url = "https://downloads.sourceforge.net/project/boost/boost-binaries/1.86.0/boost_1_86_0-msvc-14.3-64.exe"
          (New-Object System.Net.WebClient).DownloadFile($Url, "$RUNNER_TEMP\boost.exe")
          Start-Process -Wait -FilePath "$RUNNER_TEMP\boost.exe" "/SILENT","/SP-","/SUPPRESSMSGBOXES","/DIR=C:\local\boost"
          echo "BOOST_ROOT=C:\local\boost" >> $env:GITHUB_ENV

      - name: Build Forge C API
        shell: cmd
        run: |
          cd forge
          call "%VSVARSALL%" amd64
          cmake -B build -S api/c -G Ninja ^
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ^
            -DFORGE_CAPI_BUILD_TESTS=OFF ^
            -DFORGE_CAPI_USE_STATIC_RUNTIME=ON ^
            -DCMAKE_INSTALL_PREFIX="%cd%\..\install"
          cmake --build build --config ${{ matrix.build_type }}
          cmake --install build --config ${{ matrix.build_type }}

      - name: Configure QuantLib with XAD + Forge
        shell: cmd
        run: |
          cd QuantLib
          call "%VSVARSALL%" amd64
          cmake -B build -G Ninja ^
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ^
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx }} ^
            -DXAD_WARNINGS_PARANOID=OFF ^
            -DXAD_ENABLE_JIT=ON ^
            -DXAD_STATIC_MSVC_RUNTIME=ON ^
            -DCMAKE_PREFIX_PATH="%cd%\..\install" ^
            -DQL_EXTERNAL_SUBDIRECTORIES="%cd%\..\xad;%cd%\..\xad-forge;%cd%\..\QuantLib-Risks-Cpp-Forge" ^
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks ^
            -DQL_NULL_AS_FUNCTIONS=ON ^
            -DQL_BUILD_TEST_SUITE=OFF ^
            -DQL_BUILD_EXAMPLES=OFF ^
            -DQL_BUILD_BENCHMARK=OFF ^
            -DQLRISKS_DISABLE_AAD=OFF ^
            -DQLRISKS_ENABLE_FORGE=ON ^
            -DQLRISKS_USE_FORGE_CAPI=ON ^
            -DXAD_FORGE_USE_CAPI=ON ^
            -DQLRISKS_BUILD_TEST_SUITE=ON ^
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build
        shell: cmd
        run: |
          cd QuantLib\build
          call "%VSVARSALL%" amd64
          cmake --build . --config ${{ matrix.build_type }}

      - name: Test QuantLib-Risks
        shell: cmd
        run: |
          cd QuantLib\build
          set PATH=%cd%\..\..\install\bin;%PATH%
          QuantLib-Risks-Cpp-Forge\test-suite\quantlib-risks-test-suite.exe --log_level=message
